import RPi.GPIO as GPIO
from time import sleep, strftime
from datetime import datetime
import pyrebase

config = {
    "apiKey":"AIzaSyCs7mxtAmpeXgH5SS-qKBBzu0VLLWTJFF0",
    "authDomain": "alarm-clock-app-537c6.firebaseapp.com",
    "databaseURL": "https://alarm-clock-app-537c6-default-rtdb.firebaseio.com/",
    "storageBucket": "alarm-clock-app-537c6.appspot.com"
}


GPIO.setmode(GPIO.BCM)

PIR_PIN = 21

GPIO.setup(PIR_PIN, GPIO.IN)

firebase = pyrebase.initialize_app(config)

db = firebase.database()

def sendAlarm():
    db.child("trigger").push({"id": "", "triggered": True})

def matchTime(alarms):
    utc_time = datetime.utcnow()
    current_time = utc_time.strftime("%H:%M") 
    
    time_hit = []

    for alarm in alarms.values():
        alarm_hour = alarm["time"].split(":")[0]
        current_time_hour = current_time.split(":")[0]
        alarm_minute = alarm["time"].split(":")[1]
        current_time_minute = current_time.split(":")[1]
        
        if (alarm_hour == current_time_hour and alarm_minute == current_time_minute):
            return True

    return False


try: 
    while True:
        alarms = db.child("alarms").get()
        isTimeMatched  = matchTime(alarms.val())

        if isTimeMatched:
            if GPIO.input(PIR_PIN):
                print("Motion Detected")
        sleep(60)
except KeyboardInterrupt:
    print("Exiting...")
    GPIO.cleanup()


